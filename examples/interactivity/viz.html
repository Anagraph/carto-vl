<!DOCTYPE html>
<html>

<head>
    <title>Style a feature | CARTO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <!-- Include CARTO VL JS -->
    <script src="../../dist/carto-vl.js"></script>
    <!-- Include Mapbox GL JS -->
    <script src="../../vendor/mapbox-gl-dev.js"></script>
    <!-- Include Mapbox GL CSS -->
    <link href="../../vendor/mapbox-gl-dev.css" rel="stylesheet" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        #map {
            position: absolute;
            height: 100%;
            width: 100%;
            z-index: 0;
        }

        #controls {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 200px;
            z-index: 2;
        }

        #controls h2 {
            font: 300 12px/16px 'Open Sans';
            background: rgba(0, 0, 0, 0.64);
            border-radius: 4px;
            padding: 8px 12px;
            color: #fff;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <div id="controls">
        <h2></h2>
    </div>
    <script>
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json',
            center: [0, 40],
            zoom: 4,
            dragRotate: false
        });

        carto.setDefaultAuth({
            user: 'cartogl',
            apiKey: 'YOUR_API_KEY'
        });

        const source = new carto.source.Dataset(`
    ne_10m_populated_places_simple
    `);//+($name=='Madrid')
        const style = new carto.Style(`
      width: 1 * $pop_max / @view_pop_avg
      color: ramp(linear($pop_max, @view_pop_avg, globalMax($pop_max)), temps)
      strokeColor: hsva(0.73,0.69,0.89,0.5)
      strokeWidth: 1

        @view_pop_avg: viewportAvg($pop_max)* @wadus,
        @wadus: 0.5
        @global_pop_avg: globalAvg($pop_max),
        @name: $name
        @pop_max: $pop_max
    `);
        const layer = new carto.Layer('layer', source, style);

        const interactivity = new carto.Interactivity(layer);

        function updateTitle(text) {
            document.getElementsByTagName('h2')[0].innerHTML = text;
        }

        map.on('move', () => {
            const obj = {
                global_pop_avg: style._styleSpec.variables.global_pop_avg.eval(),
                view_pop_avg: style._styleSpec.variables.view_pop_avg.eval(),
            }
            console.log(obj);
        });

        interactivity.on('featureEnter', event => {
            if (event.features.length > 0) {
                event.features[0].style.color.blendTo('rgba(255,20,255,0.7)', 100)
            }
        });

        interactivity.on('featureLeave', event => {
            if (event.features.length > 0) {
                event.features[0].style.color.reset(100);
            }
        });

        interactivity.on('featureClick', event => {
            if (event.features.length > 0) {
                const feature = event.features[0];
                feature.style.strokeWidth.blendTo('4', 100);
                feature.style.strokeColor.blendTo('rgb(255,20,138)', 100);
                updateTitle(`${feature.style.variables.name.value}: ${feature.style.variables.pop_max.value}`);
                style._styleSpec.variables.wadus.blendTo(0.1);
            }
        });

        interactivity.on('featureClickOut', event => {
            if (event.features.length > 0) {
                const feature = event.features[0];
                feature.style.strokeWidth.reset(100);
                feature.style.strokeColor.reset(100);
            }
        });

        layer.on('loaded', () => {
            updateTitle('Hover or Click on a country');
        });

        layer.addTo(map, 'watername_ocean');

        function updateTitle(text) {
            document.getElementsByTagName('h2')[0].innerHTML = text;
        }
    </script>
</body>

</html>